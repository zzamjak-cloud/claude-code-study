rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 헬퍼 함수들

    // 워크스페이스 소유자 확인 (workspace.ownerId)
    function isWorkspaceOwner(workspaceId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/workspaces/$(workspaceId)) &&
             get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid;
    }

    // 최고 관리자 확인 (superAdmins 컬렉션에 이메일 등록)
    function isSuperAdmin(workspaceId) {
      return request.auth != null &&
             request.auth.token.email != null &&
             exists(/databases/$(database)/documents/superAdmins/$(workspaceId)/admins/$(request.auth.token.email));
    }

    // 관리 권한 확인 (workspace 소유자 또는 superAdmins에 등록된 사용자)
    function hasAdminAccess(workspaceId) {
      return isWorkspaceOwner(workspaceId) || isSuperAdmin(workspaceId);
    }

    // 워크스페이스 생성 권한 확인 (workspace가 없을 때 생성 가능)
    function canCreateWorkspace(workspaceId) {
      return request.auth != null &&
             !exists(/databases/$(database)/documents/workspaces/$(workspaceId));
    }

    // 등록된 팀원 확인
    // 클라이언트 측 AuthGuard에서 이메일 매칭을 하므로
    // 여기서는 인증된 사용자인지만 체크 (읽기 전용)
    function isTeamMember(workspaceId) {
      return request.auth != null;
    }

    // 서브 관리자 확인 (isLeader = true)
    function isAdmin(workspaceId) {
      let member = get(/databases/$(database)/documents/teams/$(workspaceId)/members/$(request.auth.uid));
      return member.data.isLeader == true;
    }

    // 워크스페이스
    match /workspaces/{workspaceId} {
      // 읽기: 로그인된 모든 사용자 (워크스페이스 확인용)
      allow read: if request.auth != null;

      // 생성: workspace가 없을 때만 (첫 사용자)
      allow create: if canCreateWorkspace(workspaceId);

      // 수정/삭제: 소유자만
      allow update, delete: if isWorkspaceOwner(workspaceId);
    }

    // 팀원
    match /teams/{workspaceId}/members/{memberId} {
      // 읽기: 인증된 사용자 (AuthGuard에서 이메일 체크)
      allow read: if request.auth != null;

      // 생성: 인증된 사용자 (첫 팀원 등록)
      allow create: if request.auth != null;

      // 수정: 관리자이거나, rowCount/memo만 변경하는 경우 (행 추가/제거, 메모)
      allow update: if hasAdminAccess(workspaceId) ||
                       (request.auth != null &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rowCount', 'memo', 'updatedAt']));

      // 삭제: 관리자만
      allow delete: if hasAdminAccess(workspaceId);
    }

    // 일정
    match /schedules/{workspaceId}/items/{scheduleId} {
      // 읽기: 등록된 팀원
      allow read: if request.auth != null && isTeamMember(workspaceId);

      // 쓰기: 등록된 팀원 (향후 자신의 일정만 수정하도록 제한 가능)
      allow create, update, delete: if request.auth != null && isTeamMember(workspaceId);
    }

    // 특이사항
    match /events/{workspaceId}/items/{eventId} {
      // 읽기: 등록된 팀원
      allow read: if request.auth != null && isTeamMember(workspaceId);

      // 쓰기: 등록된 팀원
      allow create, update, delete: if request.auth != null && isTeamMember(workspaceId);
    }

    // 글로벌 특이사항
    match /globalEvents/{workspaceId}/items/{eventId} {
      // 읽기: 인증된 사용자
      allow read: if request.auth != null;

      // 생성: 인증된 사용자
      allow create: if request.auth != null;

      // 수정/삭제: 인증된 사용자 (프로젝트 구성원 모두 편집 가능)
      allow update, delete: if request.auth != null;
    }

    // 프로젝트
    match /projects/{workspaceId}/items/{projectId} {
      // 읽기: 인증된 사용자
      allow read: if request.auth != null;

      // 생성: 인증된 사용자 (첫 프로젝트)
      allow create: if request.auth != null;

      // 수정/삭제: 관리자만
      allow update, delete: if hasAdminAccess(workspaceId);
    }

    // 공지사항 (프로젝트별)
    // 경로: announcements/{workspaceId}/projects/{projectId}
    match /announcements/{workspaceId}/projects/{projectId} {
      // 읽기: 인증된 사용자
      allow read: if request.auth != null;

      // 생성: 인증된 사용자
      allow create: if request.auth != null;

      // 수정/삭제: 관리자만
      allow update, delete: if hasAdminAccess(workspaceId);
    }

    // 전역 공지사항 (워크스페이스 전체)
    // 경로: announcements/{workspaceId}
    match /announcements/{workspaceId} {
      // 읽기: 인증된 사용자
      allow read: if request.auth != null;

      // 생성: 인증된 사용자
      allow create: if request.auth != null;

      // 수정/삭제: 관리자만
      allow update, delete: if hasAdminAccess(workspaceId);
    }

    // 글로벌 공지
    match /globalNotices/{workspaceId}/items/{noticeId} {
      // 읽기: 인증된 사용자
      allow read: if request.auth != null;

      // 생성: 인증된 사용자
      allow create: if request.auth != null;

      // 수정/삭제: 관리자만
      allow update, delete: if hasAdminAccess(workspaceId);
    }

    // 글로벌 이벤트 설정 (행 개수 등)
    match /globalEventSettings/{workspaceId} {
      // 읽기: 인증된 사용자
      allow read: if request.auth != null;

      // 생성: 인증된 사용자
      allow create: if request.auth != null;

      // 수정: 인증된 사용자 (rowCounts만 변경하는 경우) 또는 관리자
      allow update: if request.auth != null &&
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rowCounts', 'updatedAt']) ||
                        hasAdminAccess(workspaceId));

      // 삭제: 관리자만
      allow delete: if hasAdminAccess(workspaceId);
    }

    // 워크스페이스 설정 (커스텀 직군 등)
    match /workspaceSettings/{workspaceId} {
      // 읽기: 인증된 사용자
      allow read: if request.auth != null;

      // 생성: 인증된 사용자
      allow create: if request.auth != null;

      // 수정: 관리자만
      allow update: if hasAdminAccess(workspaceId);

      // 삭제: 관리자만
      allow delete: if hasAdminAccess(workspaceId);
    }

    // 최고 관리자 목록
    match /superAdmins/{workspaceId}/admins/{adminId} {
      // 읽기: 인증된 사용자 (권한 확인용)
      allow read: if request.auth != null;

      // 생성/수정/삭제: 소유자만
      allow create, update, delete: if isWorkspaceOwner(workspaceId);
    }
  }
}
